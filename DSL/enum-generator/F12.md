# F12키 정의로 가기 기능 설정 작업 정리

## 문제점

### 1. 초기 문제: HLS 버전 불일치
- **오류 메시지**: `Failed to find a HLS version for GHC 9.10.3`
- **원인**: 프로젝트가 GHC 9.10.3을 사용하고 있었지만, 해당 버전용 Haskell Language Server(HLS)가 설치되어 있지 않음
- **증상**: IDE에서 F12키(정의로 가기) 기능이 작동하지 않음

### 2. 두 번째 문제: GHC 버전 불일치
- **오류 메시지**: `GHC versions don't match! Expected: 9.10.2 Got: 9.10.3`
- **원인**: HLS는 GHC 9.10.2로 컴파일되었지만, 프로젝트는 GHC 9.10.3을 사용
- **증상**: HLS 서버가 계속 크래시하며 재시작 실패

## 해결 과정

### 1단계: 환경 확인
```bash
# 현재 GHC 버전 확인
ghc --version  # 9.6.7 (시스템)
stack exec ghc -- --version  # 9.10.3 (프로젝트)

# HLS 설치 상태 확인
ghcup list  # HLS 2.11.0.0 설치됨
```

### 2단계: HLS 설치 시도
```bash
# GHC 9.10.3용 HLS 설치 시도 (실패)
stack install haskell-language-server  # 의존성 충돌로 실패

# GHCup을 통한 HLS 설치
ghcup install hls 2.11.0.0  # 이미 설치됨
```

### 3단계: 호환성 문제 해결
```bash
# GHC 9.10.3용 HLS 바이너리가 없음을 확인
ls ~/.ghcup/hls/2.11.0.0/bin/
# haskell-language-server-9.10.2만 존재, 9.10.3은 없음

# 심볼릭 링크로 임시 해결 시도
ln -sf ~/.ghcup/hls/2.11.0.0/bin/haskell-language-server-9.10.2 ~/.ghcup/bin/haskell-language-server-9.10.3
```

### 4단계: 근본적 해결 - GHC 버전 다운그레이드
```bash
# GHC 9.8.4 설치 (LTS 23.24에서 지원)
ghcup install ghc 9.8.4

# stack.yaml 수정
# 기존: url: https://raw.githubusercontent.com/commercialhaskell/stackage-snapshots/master/lts/24/12.yaml
# 변경: snapshot: lts-23.24

# 프로젝트 재설정
stack setup
stack build
```

### 5단계: PATH 설정
```bash
# GHCup bin 디렉토리를 PATH에 추가
echo 'export PATH="$HOME/.ghcup/bin:$PATH"' >> ~/.bashrc
export PATH="$HOME/.ghcup/bin:$PATH"
```

### 6단계: VS Code 워크스페이스 설정
`haskell.code-workspace` 파일을 생성하여 HLS 설정을 최적화:

```json
{
    "folders": [
        {
            "name": "Haskell Projects",
            "path": "."
        },
        {
            "name": "Enum Generator",
            "path": "./DSL/enum-generator"
        }
    ],
    "settings": {
        "haskell.serverExecutablePath": "haskell-language-server-wrapper",
        "haskell.formattingProvider": "ormolu",
        "haskell.hlint.enable": true,
        "haskell.manageHLS": "GHCup",
        "haskell.trace.server": "messages",
        "haskell.serverArgs": ["--lsp"],
        "haskell.maxCompletions": 40,
        "haskell.completionSnippetsOn": true,
        "haskell.ghcide.enable": false
    }
}
```

**중요한 설정 설명:**
- `haskell.serverExecutablePath`: HLS 래퍼 사용으로 자동 버전 감지
- `haskell.manageHLS`: GHCup을 통한 HLS 관리
- `haskell.trace.server`: 서버 메시지 추적으로 디버깅 가능
- `haskell.ghcide.enable`: false로 설정하여 HLS만 사용

## 최종 결과

### 성공적으로 해결된 사항
- ✅ HLS 2.11.0.0이 GHC 9.8.4와 호환되어 정상 작동
- ✅ 프로젝트가 성공적으로 빌드됨
- ✅ F12키 정의로 가기 기능이 정상 작동
- ✅ IDE에서 코드 자동완성, 타입 체크, 오류 표시 등 모든 기능 사용 가능

### 최종 환경
- **GHC 버전**: 9.8.4 (LTS 23.24)
- **HLS 버전**: 2.11.0.0
- **Stack 버전**: 3.3.1
- **프로젝트 설정**: LTS 23.24 스냅샷 사용

## 교훈

1. **GHC 버전 호환성**: 최신 GHC 버전이 항상 HLS에서 지원되는 것은 아님
2. **LTS 스냅샷 사용**: 안정적인 LTS 스냅샷을 사용하는 것이 좋음
3. **단계적 접근**: 문제를 단계별로 분석하고 해결하는 것이 중요
4. **환경 설정**: PATH 설정과 같은 기본적인 환경 설정이 중요함
5. **VS Code 워크스페이스 설정**: 적절한 HLS 설정이 IDE 기능 작동에 핵심적
6. **HLS 래퍼 사용**: `haskell-language-server-wrapper`를 사용하면 자동으로 올바른 버전 감지

## 참고 명령어

```bash
# HLS 상태 확인
haskell-language-server-9.8.4 --version
haskell-language-server-9.8.4 --print-cradle

# 프로젝트 빌드
stack build

# GHC 버전 확인
stack exec ghc -- --version

# VS Code에서 워크스페이스 열기
code haskell.code-workspace

# HLS 래퍼 확인
which haskell-language-server-wrapper
haskell-language-server-wrapper --version
```

## 추가 팁

- **워크스페이스 사용**: VS Code에서 `haskell.code-workspace` 파일을 열어서 프로젝트를 시작하면 모든 HLS 설정이 자동으로 적용됩니다.
- **디버깅**: `haskell.trace.server` 설정으로 HLS 로그를 확인하여 문제를 진단할 수 있습니다.
- **자동완성**: `haskell.maxCompletions`와 `haskell.completionSnippetsOn` 설정으로 자동완성 기능을 최적화할 수 있습니다.
